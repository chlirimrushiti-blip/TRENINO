<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Treno â€“ Puzzle Piste & Passeggeri</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#27ae60">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
...

*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:system-ui, Arial, sans-serif;
  background:#8fd79a;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  padding:20px;
}

.game{
  background:#c8f5c6;
  padding:16px 16px 24px;
  border-radius:26px;
  box-shadow:0 8px 18px rgba(0,0,0,0.18);
}

/* toolbar */

.toolbar{
  display:flex;
  gap:10px;
  margin-bottom:10px;
  justify-content:center;
  flex-wrap:wrap;
}

.tool-btn{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  min-width:70px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  background:#ffffff;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
}
.tool-btn svg{width:26px;height:26px;}
.tool-btn span{font-size:11px;}
.tool-btn.active{background:#00c3a1;color:#fff;}
.tool-btn.erase.active{background:#e74c3c;color:#fff;}

.controls{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.play-btn{
  border:none;
  border-radius:999px;
  padding:8px 18px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  color:#fff;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
#startTrain{background:#27ae60;}
#stopTrain{background:#e67e22;}
.preset-btn{background:#2980b9;}

/* board */

.board-wrapper{
  background:linear-gradient(#9fdfff 0 30%, #b0f1ac 30%);
  padding:14px;
  border-radius:22px;
  box-shadow: inset 0 0 0 2px rgba(255,255,255,0.6);
  position:relative;
  overflow:hidden;
}

/* lago in basso a destra */
.board-wrapper::before{
  content:"";
  position:absolute;
  width:260px;
  height:140px;
  background:#7fd3ff;
  border-radius:50%;
  bottom:4%;
  right:4%;
  opacity:0.8;
}

.board{
  position:relative;
  display:grid;
  grid-template-columns:repeat(10,64px);
  grid-template-rows:repeat(7,64px);
  gap:4px;
}

.cell{
  width:64px;
  height:64px;
  border-radius:14px;
  position:relative;
  cursor:pointer;
}

.track-layer,
.object-layer{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}

.track-svg{width:100%;height:100%;}

/* oggetti grandi */
.object-layer svg{
  width:95%;
  height:95%;
}

/* treni */

.train-car{
  position:absolute;
  width:34px;
  height:34px;
  transform:translate(-50%,-50%);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  pointer-events:none;
  text-shadow:0 2px 3px rgba(0,0,0,0.35);
}
</style>
</head>
<body>
<div class="game">

  <!-- BINARI -->
  <div class="toolbar">
    <button class="tool-btn active" data-tool="h">
      <svg viewBox="0 0 100 100">
        <line x1="0" y1="35" x2="100" y2="35" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
        <line x1="0" y1="65" x2="100" y2="65" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
      </svg>
      <span>dritto â†”</span>
    </button>

    <button class="tool-btn" data-tool="v">
      <svg viewBox="0 0 100 100">
        <line x1="35" y1="0" x2="35" y2="100" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
        <line x1="65" y1="0" x2="65" y2="100" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
      </svg>
      <span>dritto â†•</span>
    </button>

    <button class="tool-btn" data-tool="ne">
      <svg viewBox="0 0 100 100">
        <g transform="rotate(-90 50 50)">
          <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
          <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        </g>
      </svg>
      <span>curva â†—</span>
    </button>

    <button class="tool-btn" data-tool="nw">
      <svg viewBox="0 0 100 100">
        <g transform="rotate(180 50 50)">
          <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
          <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        </g>
      </svg>
      <span>curva â†–</span>
    </button>

    <button class="tool-btn" data-tool="se">
      <svg viewBox="0 0 100 100">
        <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
      </svg>
      <span>curva â†˜</span>
    </button>

    <button class="tool-btn" data-tool="sw">
      <svg viewBox="0 0 100 100">
        <g transform="rotate(90 50 50)">
          <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
          <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        </g>
      </svg>
      <span>curva â†™</span>
    </button>

    <button class="tool-btn erase" data-tool="erase">
      <svg viewBox="0 0 100 100">
        <line x1="20" y1="20" x2="80" y2="80" stroke="#c0392b" stroke-width="10" stroke-linecap="round"/>
        <line x1="80" y1="20" x2="20" y2="80" stroke="#c0392b" stroke-width="10" stroke-linecap="round"/>
      </svg>
      <span>cancella</span>
    </button>
  </div>

  <!-- OGGETTI: semaforo, passeggero, alberi, montagna -->
  <div class="toolbar">
    <button class="tool-btn" data-tool="signal">
      <svg viewBox="0 0 100 100">
        <rect x="42" y="28" width="16" height="42" fill="#555"/>
        <circle cx="50" cy="36" r="12" fill="#e74c3c"/>
        <circle cx="50" cy="58" r="12" fill="#2ecc71" opacity="0.25"/>
      </svg>
      <span>semaforo</span>
    </button>

    <button class="tool-btn" data-tool="passenger">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="30" r="10" fill="#f1c40f"/>
        <rect x="42" y="40" width="16" height="22" fill="#3498db"/>
        <line x1="42" y1="48" x2="34" y2="62" stroke="#2c3e50" stroke-width="5" stroke-linecap="round"/>
        <line x1="58" y1="48" x2="66" y2="62" stroke="#2c3e50" stroke-width="5" stroke-linecap="round"/>
      </svg>
      <span>passeggero</span>
    </button>

    <button class="tool-btn" data-tool="tree">
      <svg viewBox="0 0 100 100">
        <rect x="44" y="55" width="12" height="20" fill="#8e5a3c"/>
        <circle cx="50" cy="48" r="18" fill="#2ecc71"/>
      </svg>
      <span>albero</span>
    </button>

    <button class="tool-btn" data-tool="mountain">
      <svg viewBox="0 0 100 100">
        <path d="M15 80 L50 25 L85 80 Z" fill="#7f8c8d"/>
        <path d="M50 25 L60 40 L40 40 Z" fill="#ecf0f1"/>
      </svg>
      <span>montagna</span>
    </button>
  </div>

  <!-- PISTE -->
  <div class="controls">
    <button class="play-btn preset-btn" id="presetEasy">PISTA FACILE</button>
    <button class="play-btn preset-btn" id="presetMedium">PISTA MEDIA</button>
    <button class="play-btn preset-btn" id="presetHard">PISTA DIFFICILE</button>
  </div>

  <!-- PLAY/STOP -->
  <div class="controls">
    <button class="play-btn" id="startTrain">PARTENZA TRENI</button>
    <button class="play-btn" id="stopTrain">STOP</button>
  </div>

  <div class="board-wrapper">
    <div id="board" class="board"></div>

    <!-- treno 1 -->
    <div id="trainHead1" class="train-car">ðŸš‚</div>
    <div id="train1Car1" class="train-car">ðŸšƒ</div>
    <div id="train1Car2" class="train-car">ðŸšƒ</div>
    <div id="train1Car3" class="train-car">ðŸšƒ</div>

    <!-- treno 2 -->
    <div id="trainHead2" class="train-car">ðŸš‚</div>
    <div id="train2Car1" class="train-car">ðŸšƒ</div>
    <div id="train2Car2" class="train-car">ðŸšƒ</div>
    <div id="train2Car3" class="train-car">ðŸšƒ</div>

    <!-- suono -->
    <audio id="trainSound" src="ciuf.mp3" loop></audio>
  </div>
</div>

<script>
const ROWS = 7;
const COLS = 10;
const board = document.getElementById("board");
const boardWrapper = document.querySelector(".board-wrapper");
let currentTool = "h";

const cells = [];
for(let r=0;r<ROWS;r++){
  cells[r]=[];
  for(let c=0;c<COLS;c++){
    const cell=document.createElement("div");
    cell.className="cell";
    cell.dataset.r=r;
    cell.dataset.c=c;

    const trackLayer=document.createElement("div");
    trackLayer.className="track-layer";
    const objectLayer=document.createElement("div");
    objectLayer.className="object-layer";

    cell.appendChild(trackLayer);
    cell.appendChild(objectLayer);
    board.appendChild(cell);
    cells[r][c]=cell;
  }
}

/* SVG binari */

const svgTemplates = {
  h: `
    <svg class="track-svg" viewBox="0 0 100 100">
      <line x1="0"  y1="35" x2="100" y2="35" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
      <line x1="0"  y1="65" x2="100" y2="65" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
    </svg>
  `,
  v: `
    <svg class="track-svg" viewBox="0 0 100 100">
      <line x1="35" y1="0"  x2="35" y2="100" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
      <line x1="65" y1="0"  x2="65" y2="100" stroke="#8b5a2b" stroke-width="7" stroke-linecap="round"/>
    </svg>
  `,
  se: `
    <svg class="track-svg" viewBox="0 0 100 100">
      <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
      <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
    </svg>
  `,
  sw: `
    <svg class="track-svg" viewBox="0 0 100 100">
      <g transform="rotate(90 50 50)">
        <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
      </g>
    </svg>
  `,
  nw: `
    <svg class="track-svg" viewBox="0 0 100 100">
      <g transform="rotate(180 50 50)">
        <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
      </g>
    </svg>
  `,
  ne: `
    <svg class="track-svg" viewBox="0 0 100 100">
      <g transform="rotate(-90 50 50)">
        <path d="M35 100 A65 65 0 0 1 100 35" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M65 100 A35 35 0 0 1 100 65" stroke="#8b5a2b" stroke-width="7" fill="none" stroke-linecap="round"/>
      </g>
    </svg>
  `
};

/* oggetti */

const objectTemplates = {
  signal_red: `
    <svg viewBox="0 0 100 100">
      <rect x="42" y="28" width="16" height="42" fill="#555"/>
      <circle cx="50" cy="36" r="12" fill="#e74c3c"/>
      <circle cx="50" cy="58" r="12" fill="#2ecc71" opacity="0.25"/>
    </svg>
  `,
  signal_green: `
    <svg viewBox="0 0 100 100">
      <rect x="42" y="28" width="16" height="42" fill="#555"/>
      <circle cx="50" cy="36" r="12" fill="#e74c3c" opacity="0.25"/>
      <circle cx="50" cy="58" r="12" fill="#2ecc71"/>
    </svg>
  `,
  passenger: `
    <svg viewBox="0 0 100 100">
      <circle cx="50" cy="30" r="10" fill="#f1c40f"/>
      <rect x="42" y="40" width="16" height="22" fill="#3498db"/>
      <line x1="42" y1="48" x2="34" y2="62" stroke="#2c3e50" stroke-width="5" stroke-linecap="round"/>
      <line x1="58" y1="48" x2="66" y2="62" stroke="#2c3e50" stroke-width="5" stroke-linecap="round"/>
    </svg>
  `,
  tree: `
    <svg viewBox="0 0 100 100">
      <rect x="44" y="55" width="12" height="20" fill="#8e5a3c"/>
      <circle cx="50" cy="48" r="18" fill="#2ecc71"/>
    </svg>
  `,
  mountain: `
    <svg viewBox="0 0 100 100">
      <path d="M15 80 L50 25 L85 80 Z" fill="#7f8c8d"/>
      <path d="M50 25 L60 40 L40 40 Z" fill="#ecf0f1"/>
    </svg>
  `
};

/* selezione tool */

document.querySelectorAll(".tool-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tool-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentTool = btn.dataset.tool;
  });
});

/* click sulla griglia */

board.addEventListener("click",e=>{
  const cell = e.target.closest(".cell");
  if(!cell) return;
  const trackLayer = cell.querySelector(".track-layer");
  const objectLayer = cell.querySelector(".object-layer");

  if(currentTool === "erase"){
    trackLayer.innerHTML="";
    objectLayer.innerHTML="";
    delete cell.dataset.track;
    delete cell.dataset.objectType;
    delete cell.dataset.signal;
    return;
  }

  if(svgTemplates[currentTool]){
    trackLayer.innerHTML = svgTemplates[currentTool];
    cell.dataset.track = currentTool;
    return;
  }

  if(currentTool === "signal"){
    const state = cell.dataset.signal === "red" ? "green" : "red";
    cell.dataset.signal = state;
    cell.dataset.objectType = "signal";
    objectLayer.innerHTML = objectTemplates[
      state === "red" ? "signal_red" : "signal_green"
    ];
    return;
  }

  if(objectTemplates[currentTool]){
    cell.dataset.objectType = currentTool;
    objectLayer.innerHTML = objectTemplates[currentTool];
  }
});

/* --------- PISTE PREDEFINITE + PUZZLE ---------- */

function createEmptyGrid(){
  return Array.from({length:ROWS},()=>Array(COLS).fill("."));
}

function createRectanglePreset(top,left,bottom,right){
  const g = createEmptyGrid();
  for(let c=left+1;c<=right-1;c++){
    g[top][c]="h";
    g[bottom][c]="h";
  }
  for(let r=top+1;r<=bottom-1;r++){
    g[r][left]="v";
    g[r][right]="v";
  }
  g[top][left]="se";
  g[top][right]="sw";
  g[bottom][left]="ne";
  g[bottom][right]="nw";
  return g;
}

/* helper serpentine */

function buildPathFromSteps(startR,startC,steps){
  const path=[];
  let r=startR, c=startC;
  path.push({r,c});
  for(const s of steps){
    for(let i=0;i<s.len;i++){
      if(s.dir==="R") c++;
      else if(s.dir==="L") c--;
      else if(s.dir==="D") r++;
      else if(s.dir==="U") r--;
      path.push({r,c});
    }
  }
  return path;
}

function gridFromPath(path){
  const g = createEmptyGrid();
  const conns = {};
  function addConn(r,c,dir){
    const key=r+","+c;
    if(!conns[key]) conns[key]=new Set();
    conns[key].add(dir);
  }
  for(let i=0;i<path.length-1;i++){
    const a=path[i], b=path[i+1];
    const dr=b.r-a.r, dc=b.c-a.c;
    let da,db;
    if(dr===0 && dc===1){ da="R"; db="L"; }
    else if(dr===0 && dc===-1){ da="L"; db="R"; }
    else if(dr===1 && dc===0){ da="B"; db="T"; }
    else if(dr===-1 && dc===0){ da="T"; db="B"; }
    else continue;
    addConn(a.r,a.c,da);
    addConn(b.r,b.c,db);
  }
  for(const key in conns){
    const [rs,cs]=key.split(",").map(Number);
    const dirs=Array.from(conns[key]).sort().join("");
    let t=".";
    if(dirs==="LR") t="h";
    else if(dirs==="BT") t="v";
    else if(dirs==="RT"||dirs==="TR") t="ne";
    else if(dirs==="LT"||dirs==="TL") t="nw";
    else if(dirs==="BR"||dirs==="RB") t="se";
    else if(dirs==="BL"||dirs==="LB") t="sw";
    g[rs][cs]=t;
  }
  return g;
}

/* serpentine miste */

function createSnakeMedium1(){
  const path = buildPathFromSteps(1,1,[
    {dir:"R",len:7},
    {dir:"D",len:1},
    {dir:"L",len:7},
    {dir:"D",len:1},
    {dir:"R",len:7},
    {dir:"D",len:1},
    {dir:"L",len:7},
    {dir:"D",len:1},
    {dir:"R",len:7},
    {dir:"D",len:1},
    {dir:"L",len:7},
    {dir:"U",len:5}
  ]);
  return gridFromPath(path);
}

function createSnakeMedium2(){
  const path = buildPathFromSteps(0,1,[
    {dir:"D",len:3},
    {dir:"R",len:7},
    {dir:"D",len:2},
    {dir:"L",len:7},
    {dir:"D",len:1},
    {dir:"R",len:7},
    {dir:"U",len:6},
    {dir:"L",len:7}
  ]);
  return gridFromPath(path);
}

function createSnakeHard1(){
  const path = buildPathFromSteps(0,0,[
    {dir:"R",len:9},
    {dir:"D",len:3},
    {dir:"L",len:8},
    {dir:"D",len:3},
    {dir:"R",len:8},
    {dir:"U",len:6},
    {dir:"L",len:9}
  ]);
  return gridFromPath(path);
}

function createSnakeHard2(){
  const path = buildPathFromSteps(0,1,[
    {dir:"R",len:7},
    {dir:"D",len:2},
    {dir:"L",len:6},
    {dir:"D",len:3},
    {dir:"R",len:6},
    {dir:"D",len:1},
    {dir:"L",len:7},
    {dir:"U",len:6}
  ]);
  return gridFromPath(path);
}

/* preset pieni â€“ tanta varietÃ  */

const presetsBase = {
  easy: [
    createRectanglePreset(1,2,5,7),
    createRectanglePreset(1,1,5,8),
    createRectanglePreset(2,1,6,8),
    createRectanglePreset(1,0,5,9)
  ],
  medium: [
    createRectanglePreset(0,2,6,7),
    createRectanglePreset(1,1,5,8),
    createSnakeMedium1(),
    createSnakeMedium2()
  ],
  hard: [
    createSnakeHard1(),
    createSnakeHard2(),
    createRectanglePreset(0,1,6,8),
    createRectanglePreset(0,0,6,9)
  ]
};

/* togli alcuni pezzi per fare il puzzle */

function addGapsForLevel(grid, level){
  const candidates=[];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const t=grid[r][c];
      if(t==="h" || t==="v"){
        candidates.push({r,c});
      }
    }
  }
  if(candidates.length===0) return grid;

  let gaps;
  if(level==="easy") gaps=2;
  else if(level==="medium") gaps=4;
  else gaps=6;
  gaps = Math.min(gaps, candidates.length-1);

  for(let i=0;i<gaps;i++){
    const idx = Math.floor(Math.random()*candidates.length);
    const {r,c} = candidates.splice(idx,1)[0];
    grid[r][c]=".";
  }
  return grid;
}

function applyPreset(grid){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell = cells[r][c];
      const trackLayer = cell.querySelector(".track-layer");
      const objectLayer = cell.querySelector(".object-layer");
      const t = grid[r][c];
      if(svgTemplates[t]){
        trackLayer.innerHTML = svgTemplates[t];
        cell.dataset.track = t;
      }else{
        trackLayer.innerHTML="";
        delete cell.dataset.track;
      }
      objectLayer.innerHTML="";
      delete cell.dataset.objectType;
      delete cell.dataset.signal;
    }
  }
}

function loadPuzzlePreset(level){
  const arr = presetsBase[level];
  if(!arr || !arr.length) return;
  const idx = Math.floor(Math.random()*arr.length);
  const base = arr[idx].map(row=>row.slice());
  const puzzle = addGapsForLevel(base, level);
  applyPreset(puzzle);
}

document.getElementById("presetEasy").addEventListener("click",()=>loadPuzzlePreset("easy"));
document.getElementById("presetMedium").addEventListener("click",()=>loadPuzzlePreset("medium"));
document.getElementById("presetHard").addEventListener("click",()=>loadPuzzlePreset("hard"));

/* --------- LOGICA TRENI ---------- */

const connections = {
  h:["L","R"],
  v:["T","B"],
  ne:["T","R"],
  nw:["T","L"],
  se:["B","R"],
  sw:["B","L"]
};
const opposite = {L:"R",R:"L",T:"B",B:"T"};

function neighbors(r,c){
  return {
    L:[r,c-1],
    R:[r,c+1],
    T:[r-1,c],
    B:[r+1,c]
  };
}
function inBounds(r,c){
  return r>=0 && r<ROWS && c>=0 && c<COLS;
}

/* posizione centro cella */

function cellCenter(r,c){
  const cellRect = cells[r][c].getBoundingClientRect();
  const wrapRect = boardWrapper.getBoundingClientRect();
  const centerX = cellRect.left - wrapRect.left + cellRect.width/2;
  const centerY = cellRect.top  - wrapRect.top  + cellRect.height/2;
  const offsetY = 2;
  return {x:centerX, y:centerY+offsetY};
}

/* costruzione percorso â€“ deve essere un ANELLO CHIUSO */

let pathPoints = null;
let pathCells = null;

function buildPath(){
  let start=null;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(cells[r][c].dataset.track){
        start={r,c};
        break;
      }
    }
    if(start) break;
  }
  if(!start) return null;

  const track = cells[start.r][start.c].dataset.track;
  let dirs = connections[track];
  if(!dirs) return null;

  let dir = dirs[0];
  let r = start.r;
  let c = start.c;
  const visited=[];
  const maxSteps = ROWS*COLS*4;
  let closed=false;

  for(let i=0;i<maxSteps;i++){
    visited.push({r,c});
    const neighMap = neighbors(r,c);
    const nb = neighMap[dir];
    if(!nb) break;
    const [nr,nc] = nb;
    if(!inBounds(nr,nc)) break;
    const ncell = cells[nr][nc];
    const ntype = ncell.dataset.track;
    if(!ntype) break;
    const ncon = connections[ntype];
    if(!ncon || !ncon.includes(opposite[dir])) break;
    const ways = ncon.filter(d=>d!==opposite[dir]);
    const nextDir = ways[0] || opposite[dir];
    r=nr; c=nc; dir=nextDir;
    if(r===start.r && c===start.c){
      visited.push({r,c});
      closed=true;
      break;
    }
  }
  if(visited.length<2 || !closed) return null;

  pathCells = visited;
  pathPoints = visited.map(p=>cellCenter(p.r,p.c));
  return pathPoints;
}

/* animazione */

const trainHead1=document.getElementById("trainHead1");
const train1Car1=document.getElementById("train1Car1");
const train1Car2=document.getElementById("train1Car2");
const train1Car3=document.getElementById("train1Car3");

const trainHead2=document.getElementById("trainHead2");
const train2Car1=document.getElementById("train2Car1");
const train2Car2=document.getElementById("train2Car2");
const train2Car3=document.getElementById("train2Car3");

const trainSound=document.getElementById("trainSound");

let running=false;
let tPos=0;
let lastTime=null;
const speed=2;

let passengersOnBoard1=0;
let passengersOnBoard2=0;
let passengerStopUntil1=0;
let passengerStopUntil2=0;

function updatePassengerVisualTrain1(){
  train1Car1.textContent="ðŸšƒ";
  train1Car2.textContent="ðŸšƒ";
  train1Car3.textContent="ðŸšƒ";
  if(passengersOnBoard1>=1) train1Car1.textContent="ðŸšƒðŸ‘¦";
  if(passengersOnBoard1>=2) train1Car2.textContent="ðŸšƒðŸ‘¦";
  if(passengersOnBoard1>=3) train1Car3.textContent="ðŸšƒðŸ‘¦";
}

function updatePassengerVisualTrain2(){
  train2Car1.textContent="ðŸšƒ";
  train2Car2.textContent="ðŸšƒ";
  train2Car3.textContent="ðŸšƒ";
  if(passengersOnBoard2>=1) train2Car1.textContent="ðŸšƒðŸ‘¦";
  if(passengersOnBoard2>=2) train2Car2.textContent="ðŸšƒðŸ‘¦";
  if(passengersOnBoard2>=3) train2Car3.textContent="ðŸšƒðŸ‘¦";
}

function positionOnPath(t){
  if(!pathPoints || pathPoints.length<2) return {x:0,y:0};
  const n = pathPoints.length;
  t = (t%n+n)%n;
  const i = Math.floor(t);
  const frac = t - i;
  const p1 = pathPoints[i];
  const p2 = pathPoints[(i+1)%n];
  return {
    x: p1.x + (p2.x-p1.x)*frac,
    y: p1.y + (p2.y-p1.y)*frac
  };
}

function updateTrain(head,carA,carB,carC,offset){
  if(!pathPoints) return;
  const base = tPos + offset;
  const headPos = positionOnPath(base);
  const car1Pos = positionOnPath(base-1);
  const car2Pos = positionOnPath(base-2);
  const car3Pos = positionOnPath(base-3);

  head.style.left=headPos.x+"px";
  head.style.top=headPos.y+"px";
  carA.style.left=car1Pos.x+"px";
  carA.style.top=car1Pos.y+"px";
  carB.style.left=car2Pos.x+"px";
  carB.style.top=car2Pos.y+"px";
  carC.style.left=car3Pos.x+"px";
  carC.style.top=car3Pos.y+"px";
}

function animateTrain(ts){
  if(!running) return;
  if(!lastTime) lastTime=ts;
  const dt = (ts-lastTime)/1000;
  lastTime=ts;

  if(pathPoints && pathCells){
    const n=pathPoints.length;

    let idx1 = Math.floor((tPos % n + n) % n);
    let idx2 = Math.floor(((tPos + n/2) % n + n) % n);

    const cellInfo1 = pathCells[idx1];
    const cellInfo2 = pathCells[idx2];
    const cell1 = cells[cellInfo1.r][cellInfo1.c];
    const cell2 = cells[cellInfo2.r][cellInfo2.c];

    let stopHere = false;

    // semaforo rosso ferma entrambi
    if(cell1.dataset.signal === "red" || cell2.dataset.signal === "red"){
      stopHere = true;
    }

    // passeggeri per treno 1
    if(cell1.dataset.objectType === "passenger"){
      if(passengerStopUntil1 < ts){
        passengerStopUntil1 = ts + 800;
        cell1.dataset.objectType = "";
        const ol = cell1.querySelector(".object-layer");
        if(ol) ol.innerHTML="";
        passengersOnBoard1++;
        updatePassengerVisualTrain1();
      }
    }
    if(passengerStopUntil1 > ts){
      stopHere = true;
    }

    // passeggeri per treno 2
    if(cell2.dataset.objectType === "passenger"){
      if(passengerStopUntil2 < ts){
        passengerStopUntil2 = ts + 800;
        cell2.dataset.objectType = "";
        const ol2 = cell2.querySelector(".object-layer");
        if(ol2) ol2.innerHTML="";
        passengersOnBoard2++;
        updatePassengerVisualTrain2();
      }
    }
    if(passengerStopUntil2 > ts){
      stopHere = true;
    }

    if(!stopHere){
      tPos += speed*dt;
    }

    updateTrain(trainHead1,train1Car1,train1Car2,train1Car3,0);
    if(n>=4){
      const offset2 = n/2;
      updateTrain(trainHead2,train2Car1,train2Car2,train2Car3,offset2);
    }
  }
  requestAnimationFrame(animateTrain);
}

/* start/stop */

document.getElementById("startTrain").addEventListener("click",()=>{
  const ok = buildPath();
  if(!ok){
    alert("Completa la pista: mancano ancora dei binari per chiudere il giro!");
    return;
  }
  running=true;
  lastTime=null;
  tPos=0;
  passengersOnBoard1=0;
  passengersOnBoard2=0;
  passengerStopUntil1=0;
  passengerStopUntil2=0;
  updatePassengerVisualTrain1();
  updatePassengerVisualTrain2();
  try{
    trainSound.currentTime=0;
    trainSound.play();
  }catch(e){}
  requestAnimationFrame(animateTrain);
});

document.getElementById("stopTrain").addEventListener("click",()=>{
  running=false;
  trainSound.pause();
  passengersOnBoard1=0;
  passengersOnBoard2=0;
  passengerStopUntil1=0;
  passengerStopUntil2=0;
  updatePassengerVisualTrain1();
  updatePassengerVisualTrain2();
});
</script>

<script>
// --- REGISTRAZIONE SERVICE WORKER --- //
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js")
      .catch(err => console.error("SW registration failed:", err));
  });
}
</script>

</body>
</html>

